<!DOCTYPE html><html><head><meta charset="UTF-8"><link media="screen,projection" href="../../contrib/materialize/materialize.min.css" type="text/css" rel="stylesheet"></link><link href="../../contrib/katex/katex.min.css" type="text/css" rel="stylesheet"></link><link href="../../contrib/prism/prism.min.css" type="text/css" rel="stylesheet"></link><link href="../../css/moose.css" type="text/css" rel="stylesheet"></link><script src="../../contrib/jquery/jquery.min.js" type="text/javascript"></script><script src="../../contrib/materialize/materialize.min.js" type="text/javascript"></script><script src="../../contrib/clipboard/clipboard.min.js" type="text/javascript"></script><script src="../../contrib/prism/prism.min.js" type="text/javascript"></script><script src="../../contrib/katex/katex.min.js" type="text/javascript"></script><script src="../../contrib/fuse/fuse.min.js" type="text/javascript"></script><script src="../../js/search_index.js" type="text/javascript"></script><script src="../../js/init.js" type="text/javascript"></script><title>Jacobian   Debugger   analyze_jacobian.py|Numbat</title></head><body><div class="page-wrap"><header><nav><div class="nav-wrapper container"><a href="https://github.com/cpgr/numbat" class="right"><img src="../../media/github-logo.png" class="github-mark"></img><img src="../../media/github-mark.png" class="github-logo"></img></a><a href="http://cpgr.github.io/numbat/" class="left moose-logo">Numbat</a><ul class="right hide-on-med-and-down" id="nav-mobile"><li><a data-constrainWidth="false" href="#!" class="dropdown-button" data-activates="d3758564-0736-4efd-8195-04f147afeb23">Getting Started<i class="material-icons right">arrow_drop_down</i></a></li><li><a data-constrainWidth="false" href="#!" class="dropdown-button" data-activates="b26de45d-4800-4a0a-9c27-0ae8ef342b63">Theory<i class="material-icons right">arrow_drop_down</i></a></li><li><a data-constrainWidth="false" href="#!" class="dropdown-button" data-activates="1c4f8b95-fad2-49e4-9fe8-3b9adbe06dc2">Details<i class="material-icons right">arrow_drop_down</i></a></li><li><a data-constrainWidth="false" href="#!" class="dropdown-button" data-activates="f7e232df-fe3b-4628-93d8-986f445eb4cc">Examples<i class="material-icons right">arrow_drop_down</i></a></li><li><a data-constrainWidth="false" href="#!" class="dropdown-button" data-activates="13ea70d4-4245-4e28-8716-5dbc8ca56947">Manual<i class="material-icons right">arrow_drop_down</i></a></li></ul><ul class="dropdown-content" id="d3758564-0736-4efd-8195-04f147afeb23"><li><a href="../../getting_started.html">Installation</a></li></ul><ul class="dropdown-content" id="b26de45d-4800-4a0a-9c27-0ae8ef342b63"><li><a href="../../introduction.html">Introduction</a></li><li><a href="../../governing_equations.html">Governing equations</a></li></ul><ul class="dropdown-content" id="1c4f8b95-fad2-49e4-9fe8-3b9adbe06dc2"><li><a href="../../implementation.html">Implementation</a></li><li><a href="../../input_file_syntax.html">Input file syntax</a></li><li><a href="../../running_numbat.html">Running Numbat</a></li><li><a href="../../systems.html">Available objects</a></li></ul><ul class="dropdown-content" id="f7e232df-fe3b-4628-93d8-986f445eb4cc"><li><a href="../../example2D.html">2D</a></li><li><a href="../../example3D.html">3D</a></li></ul><ul class="dropdown-content" id="13ea70d4-4245-4e28-8716-5dbc8ca56947"><li><a href="../../download.html">User manual</a></li></ul><a href="#moose-search" class="modal-trigger"><i class="material-icons">search</i></a></div></nav><div class="modal modal-fixed-footer moose-search-modal" id="moose-search"><div class="modal-content container moose-search-modal-content"><div class="row"><div class="col l12"><div class="input-field"><input autocomplete="off" onkeyup="mooseSearch()" type="text" id="moose-search-box"><label for="search">http://cpgr.github.io/numbat/</label></input></div></div><div><div class="col s12" id="moose-search-results"></div></div></div></div><div class="modal-footer"><a href="#!" class="modal-action modal-close btn-flat">Close</a></div></div></header><main class="main"><div class="container"><div class="row"><div class="col hide-on-med-and-down l12"><nav class="breadcrumb-nav"><div class="nav-wrapper"><span class="breadcrumb">help</span><a href="." class="breadcrumb">development</a><a href="analyze_jacobian.html" class="breadcrumb">analyze_jacobian</a></div></nav></div></div><div class="row"><div class="moose-content col s12 m12 l10"><section data-section-text="Jacobian   Debugger   analyze_jacobian.py" data-section-level="1" id="59bdd0e1-3a2c-48b3-9a48-154994e393cc"><h1>Jacobian Debugger <code>analyze_jacobian.py</code></h1><p>When developing MOOSE Kernels bugs in the implementation of the On- and Off-Diagonal Jacobian may lead to bad (or no) convergence of problems utilizing the new kernel. MOOSE comes with a Jacobian Debugger script to assist the developers with this task.</p><p>The Jacobian debugger uses internal PETSc functionality to create a finite differenced Jacobian matrix from the residuals and compares it to the implemented Jacobian (usually found in <code>computeQpJacobian</code> and <code>computeQpOffDiagJacobian</code>).</p><div class="card moose-alert moose-alert-warning"><div class="card-content"><div class="moose-alert-title card-title"><span class="moose-alert-title-brand">warning</span></div><div class="moose-alert-content"><p><p>Note that MOOSE by default only uses the on-diagonal Jacobian entries and will not call your <code>computeQpOffDiagJacobian</code> implementations at all. To test those add the following block to your input:</p><pre style="background:#666"><code class="language-text">
[Preconditioning]
  [./SMP]
    type = SMP
    full = true
  [../]
[]
</code></pre></p></div></div></div><p>Then simply run the Jacobian Debugger on your input file as follows:</p><pre><code class="language-bash">
$MOOSE_DIR/python/jacobiandebug/analyzejacobian.py input_file.i
</code></pre><p>This runs the moose application (same autodetection peacock uses) and computes the Jacobian using the user supplied <code>compute[..]Jacobian()</code> methods and through finite differencing the residuals. If both Jacobian matrices agree the analyzer outputs.</p><pre><code class="language-text">
No errors detected. :-)
</code></pre><p>Otherwise it outputs a human readable diagnosis of the input file, which could look like this:</p><pre><code class="language-text">
Kernel for variable 's':
  (0,0) On-diagonal Jacobian is slightly off (by 0.500073 %)

Kernel for variable 't':
  (1,1) On-diagonal Jacobian is wrong (off by 100.0 %)
  (1,2) Off-diagonal Jacobian for variable 'u' is questionable (off by 4.5 %)

Kernel for variable 'u':
  (2,2) On-diagonal Jacobian needs to be implemented

Kernel for variable 'u2':
  (3,3) On-diagonal Jacobian should just return  zero
</code></pre><p>Note how the analyzer puts relative discrepancies between the hand coded and finite differenced into natural language.</p><div class="card moose-alert moose-alert-note"><div class="card-content"><div class="moose-alert-title card-title"><span class="moose-alert-title-brand">note</span></div><div class="moose-alert-content"><p>During the Jacobian analysis <strong>no solve</strong> is being performed. The Jacobian is checked at exactly the given initial conditions. Set this IC carefully.</p></div></div></div><p>The Jacobian analyzer is still under development and a major feature that is being worked on is the output of the faulty kernel class names. This is not straightforward as in an input file multiple kernels can be contributing to the residual/Jacobian of any given variable.</p><section class="section scrollspy" data-section-text="Tips" data-section-level="2" id="f05ef375-42c2-41dc-af91-85ea7dc47f25"><h2>Tips</h2><ul class="browser-default"><li><p>Use a <code>RandomIC</code> on each variable to make sure that the values and gradients of your variables are non-zero to avoid trivial Jacobians. </p></li><li><p>Reduce the mesh in size to greatly speed up the analysis. This can be done with the <code>-r</code> and <code>-s</code> options.</p></li></ul></section><section class="section scrollspy" data-section-text="Advanced" data-section-level="2" id="035dacc4-b3eb-496f-9364-9767dbe8dfb8"><h2>Advanced</h2><p>To view the available commandline options for the Jacobian Debugger run the script with the <code>--help</code> option</p><pre><code class="language-bash">
$MOOSE_DIR/python/jacobiandebug/analyzejacobian.py --help
</code></pre><p>Notable options are:</p><ul class="browser-default"><li><p><code>-r</code>, <code>--resize-mesh</code></p><ul class="browser-default"><li><p>Perform resizing of generated meshs to speed up the testing. </p></li><li><p>This option will attempt to reduce the number of elements in a <code>type = GeneratedMesh</code> mesh by setting the <code>nx</code>, <code>ny</code>, and <code>nz</code> values to either 1 or the value given by option <code>-s</code></p></li></ul><p></p></li><li><p><code>-s MESH_SIZE</code>, <code></code>&ndash;mesh-size=MESH_SIZE`</p><ul class="browser-default"><li><p>Set the mesh dimensions to this number of elements along each dimension (defaults to 1, requires <code>-r</code> option).</p></li></ul><p></p></li><li><p><code>-e EXECUTABLE</code>, <code>--executable=EXECUTABLE</code></p><ul class="browser-default"><li><p>The executable you would like to build an input file for. If not supplied an executable will be searched for. The searched for executable will default to the optimized version of the executable (if available). </p></li><li><p>As in peacock executables are first search in the current directory, and then in the parent directories.</p></li></ul><p></p></li><li><p><code>-d</code>, <code>--debug</code></p><ul class="browser-default"><li><p>Output the command line used to run the application. </p></li><li><p>This shows exactly which commands are run to acquire the data needed to analyze the Jacobian matrix. Useful to debug the analyzer itself in case of failures.</p></li></ul></li></ul></section><section class="section scrollspy" data-section-text="Further   notes" data-section-level="2" id="6f4d47af-4eb5-41d8-a7ad-0fd8a239684e"><h2>Further notes</h2><ul class="browser-default"><li><p><code>analyzejacobian.py</code> will not work if you have <code>solve_type = PJFNK</code> in an active <code>Preconditioning</code> block (having it in the <code>Executioner</code> block is fine). </p></li><li><p><code>analyzejacobian.py</code> turns off boundary all conditions, e.g. it currently tests <strong>kernels only</strong> and not integrated boundary conditions.</p></li></ul></section></section></div><div class="col hide-on-med-and-down l2"><div class="toc-wrapper pin-top"><ul class="section table-of-contents"><li><a data-delay="1000" data-position="left" href="#f05ef375-42c2-41dc-af91-85ea7dc47f25" class="tooltipped" data-tooltip="Tips">Tips</a></li><li><a data-delay="1000" data-position="left" href="#035dacc4-b3eb-496f-9364-9767dbe8dfb8" class="tooltipped" data-tooltip="Advanced">Advanced</a></li><li><a data-delay="1000" data-position="left" href="#6f4d47af-4eb5-41d8-a7ad-0fd8a239684e" class="tooltipped" data-tooltip="Further   notes">Further   notes</a></li></ul></div></div></div></div></main></div></body></html>