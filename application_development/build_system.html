<!DOCTYPE html><html><head><meta charset="UTF-8"><link media="screen,projection" href="../contrib/materialize/materialize.min.css" type="text/css" rel="stylesheet"></link><link href="../contrib/katex/katex.min.css" type="text/css" rel="stylesheet"></link><link href="../contrib/prism/prism.min.css" type="text/css" rel="stylesheet"></link><link href="../css/moose.css" type="text/css" rel="stylesheet"></link><script src="../contrib/jquery/jquery.min.js" type="text/javascript"></script><script src="../contrib/materialize/materialize.min.js" type="text/javascript"></script><script src="../contrib/clipboard/clipboard.min.js" type="text/javascript"></script><script src="../contrib/prism/prism.min.js" type="text/javascript"></script><script src="../contrib/katex/katex.min.js" type="text/javascript"></script><script src="../contrib/fuse/fuse.min.js" type="text/javascript"></script><script src="../js/search_index.js" type="text/javascript"></script><script src="../js/init.js" type="text/javascript"></script><title>MOOSE   Build   System|Numbat</title><script src="../contrib/plotly/plotly.min.js" type="text/javascript"></script></head><body><div class="page-wrap"><header><nav><div class="nav-wrapper container"><a href="https://github.com/cpgr/numbat" class="right"><img src="../media/github-logo.png" class="github-mark"></img><img src="../media/github-mark.png" class="github-logo"></img></a><a href="http://cpgr.github.io/numbat/" class="left moose-logo">Numbat</a><ul class="right hide-on-med-and-down" id="nav-mobile"><li><a data-constrainWidth="false" href="#!" class="dropdown-button" data-activates="39de54c6-9d49-4865-943a-7d305ad1e5d5">Getting Started<i class="material-icons right">arrow_drop_down</i></a></li><li><a data-constrainWidth="false" href="#!" class="dropdown-button" data-activates="479bcc6b-9f18-4b1d-938e-d5033b4953e5">Theory<i class="material-icons right">arrow_drop_down</i></a></li><li><a data-constrainWidth="false" href="#!" class="dropdown-button" data-activates="d57ba08d-4885-49b9-b010-3d5d10681dd0">Details<i class="material-icons right">arrow_drop_down</i></a></li><li><a data-constrainWidth="false" href="#!" class="dropdown-button" data-activates="42fd69b9-3bab-4359-be29-e4198f202ec6">Examples<i class="material-icons right">arrow_drop_down</i></a></li><li><a data-constrainWidth="false" href="#!" class="dropdown-button" data-activates="876f2f49-d720-4b51-a658-42ff8e6608de">Manual<i class="material-icons right">arrow_drop_down</i></a></li></ul><ul class="dropdown-content" id="39de54c6-9d49-4865-943a-7d305ad1e5d5"><li><a href="../getting_started.html">Installation</a></li></ul><ul class="dropdown-content" id="479bcc6b-9f18-4b1d-938e-d5033b4953e5"><li><a href="../introduction.html">Introduction</a></li><li><a href="../governing_equations.html">Governing equations</a></li></ul><ul class="dropdown-content" id="d57ba08d-4885-49b9-b010-3d5d10681dd0"><li><a href="../implementation.html">Implementation</a></li><li><a href="../input_file_syntax.html">Input file syntax</a></li><li><a href="../running_numbat.html">Running Numbat</a></li><li><a href="../systems.html">Available objects</a></li></ul><ul class="dropdown-content" id="42fd69b9-3bab-4359-be29-e4198f202ec6"><li><a href="../example2D.html">2D</a></li><li><a href="../example3D.html">3D</a></li></ul><ul class="dropdown-content" id="876f2f49-d720-4b51-a658-42ff8e6608de"><li><a href="../download.html">User manual</a></li></ul><a href="#moose-search" class="modal-trigger"><i class="material-icons">search</i></a></div></nav><div class="modal modal-fixed-footer moose-search-modal" id="moose-search"><div class="modal-content container moose-search-modal-content"><div class="row"><div class="col l12"><div class="input-field"><input autocomplete="off" onkeyup="mooseSearch()" type="text" id="moose-search-box"><label for="search">http://cpgr.github.io/numbat/</label></input></div></div><div><div class="col s12" id="moose-search-results"></div></div></div></div><div class="modal-footer"><a href="#!" class="modal-action modal-close btn-flat">Close</a></div></div></header><main class="main"><div class="container"><div class="row"><div class="col hide-on-med-and-down l12"><nav class="breadcrumb-nav"><div class="nav-wrapper"><a href="." class="breadcrumb">application_development</a><a href="build_system.html" class="breadcrumb">build_system</a></div></nav></div></div><div class="row"><div class="moose-content col s12 m12 l10"><section data-section-text="MOOSE   Build   System" data-section-level="1" id="88047fbc-aeae-44ea-9e35-5677e7cba319"><h1>MOOSE Build System</h1><section class="scrollspy" data-section-text="Overview" data-section-level="2" id="71009780-10cc-4571-9ec8-8114a4385fab"><h2>Overview</h2><p>The MOOSE build system is a hierarchical Makefile based system. The idea is that no matter where you are in the hierarchy of MOOSE applications/modules/framework, simply typing <code>make</code> will rebuild everything that needs to be rebuilt. The basic way to build any MOOSE application is simply to do a:</p><pre><code class="language-bash">
make
</code></pre><p>within the application directory.</p><p>Consider an application named <code>Frog</code> that depends on two of the physics modules <code>tensor_mechanics</code> and <code>heat_conduction</code>. Typing <code>make</code> within the <code>frog</code> directory will automatically build <code>framework</code>, <code>tensor_mechanics</code>, <code>heat_conduction</code> and <code>frog</code>.</p><p>In addition, the Makefiles in the MOOSE system are designed for parallel building. Using the <code>-j</code> flag when running <code>make</code> will allow you to build much faster. For instance, if you have 8 processors in your workstation you can do:</p><pre><code class="language-bash">
make -j 8
</code></pre><p>This will cause <code>make</code> to spawn 8 compilation processes at the same time, compiling up to 8x faster than a serial compile.</p></section><section class="scrollspy" data-section-text="Controlling   The   Process :   Environment   Variables" data-section-level="2" id="9d0760d1-9787-4c4a-96d0-e5158b1f87a6"><h2>Controlling The Process: Environment Variables</h2><p>The MOOSE build system relies on environment variables for control over the build process. Here are some of the environment variables you can set and their effects:</p><ul class="browser-default"><li><p><code>METHOD</code>: Set this to <code>opt</code>, <code>dbg</code>, <code>oprof</code> or <code>devel</code> to build executables with differing amounts of optimization and debugging capabilities. See the Method section below for more information. </p></li><li><p><code>METHODS</code>: A set of space separated <code>METHOD</code> options. This should enumerate all of the ways you ever want to set <code>METHOD</code> </p></li><li><p><code>MOOSE_DIR</code>: _Optional_. The directory where the MOOSE repository is. Usually the Makefile can find it unless you have very non-standard paths. </p></li><li><p><code>MOOSE_UNITY</code>: defaults to <code>true</code>, set to <code>false</code> to turn off unity builds. For more information see the Build System Optimization section below.</p></li></ul></section><section class="scrollspy" data-section-text="Build   Methods   ( Creating   " debug "   Builds )" data-section-level="2" id="559bd896-85f2-43ee-8f77-4ce6a10e31c9"><h2>Build Methods (Creating "debug" Builds)</h2><p>As mentioned above there are two environment variables that control what "type" of executable gets created: <code>METHOD</code> and <code>METHODS</code>. The executable that is ultimately created will have the <code>$METHOD</code> as a suffix like: <code>something-$METHOD</code>. The valid options are:</p><ul class="browser-default"><li><p><code>opt</code>: (The default) Builds an optimized executable suitable for running calculations. </p></li><li><p><code>dbg</code>: An executable meant for use in a debugger (like <code>gdb</code> or <code>lldb</code>). Will be very slow and not meant to be used on large problems </p></li><li><p><code>devel</code>: Something in-between <code>opt</code> and <code>dbg</code>. Attempts to be faster but also does some more run-time checks (asserts and mooseAsserts) </p></li><li><p><code>oprof</code>: Not normally used. Can be used for "code profiling": running your code with a utility like <code>oprof</code>, <code>gprof</code>, <code>vtune</code>, etc.</p></li></ul><p><code>METHODS</code> is used to specify the full set (space separated) of the above options that you will _ever_ want to used. It is used in the build of <code>libMesh</code> to build a <code>libMesh</code> library for each of the <code>METHODS</code>.</p></section><section class="scrollspy" data-section-text="Build   System   Optimization" data-section-level="2" id="68eb7733-ee52-450f-b3a5-8550c43102ac"><h2>Build System Optimization</h2><p>This is advanced information meant to inform you of optimizations that happen within the MOOSE build system. This is not necessary to understand how to use and build MOOSE.</p><p>There are two main build optimizations: "header symlinking" and "unity builds":</p><section data-section-text="Header   Symlinking" data-section-level="3" id="8922aa23-e7cf-4d58-b3cb-4cd2fbfff916"><h3>Header Symlinking</h3><p>MOOSE and MOOSE-based application's include directories are organized into sub-directories for each system (such as <code>kernels</code>, <code>bcs</code>, <code>auxkernels</code>, etc.). There are currently ~30 different MOOSE systems, meaning that each application could potentially have 30+ directories to search for include files. In addition, applications can compose/use eachother and use the physics modules. Each time you add another application/module you're gaining another 30+ include directories.</p><p>This can lead to an "explosion" of include directory paths (application + 4 modules + framework = 180 paths!). This expansion of paths can lead to the compiler slowing down as each path needs to be searched at compile time to find a header.</p><p>To combat this, during the build phase a directory named <code>build/header_symlinks</code> is created for each application/module. All of the header files within that application/module are then symlinked into that directory. This means that each application/module you add only adds _one_ include directory (instead of 30), greatly speeding up the compilation process.</p></section><section data-section-text="Unity   Builds" data-section-level="3" id="6e2b1dfc-ad2d-4e84-a8cc-06414a26de69"><h3>Unity Builds</h3><p>Within the subdirectories underneath the <code>src</code> directory of a typical MOOSE-based application you will find definitions of multiple, closely-related objects in <code>.C</code> files. For instance in <code>src/kernels</code> you would be likely to find 10-15 Kernels that all inherit from <code>Kernel.h</code>. However, if we were to compile all of these files separately (as is commonly done) each of the <code>#include</code> trees would have to be found and compiled for each one of these files individually. In addition, each of these <code>.C</code> files would create a separate <code>.o</code> file that would ultimately need to be linked into the final library / application.</p><p>A different idea is to compile all of these files together, providing considerable savings for evaluating the <code>#include</code>s and ultimately just producing _one_ <code>.o</code> file to be linked. This can provide a huge savings in compile time. The following is showing timing for <code>make -j 16</code> for various sets of applications/modules/framework on the Falcon computer at Idaho National Laboratory. It is plain to see how much time is saved by using both header symlinking and unity builds.</p><div style="width:50%;float:right;margin-left:20px;" class="card"><div class="card-image"><img src="../media/application_development/falcon_compile_speed.png" class="materialboxed moose-image"></img><p class="moose-caption"><span class="moose-caption-text">Compile speed on Falcon.</span></p></div></div><p>The way we achieve this in MOOSE is using the idea of "Unity Builds". A Unity Build compiles multiple <code>.C</code> files together by create a <code>.C</code> file that <code>#include</code>s all of the other <code>.C</code> files. In MOOSE this happens in a directory called <code>build/unity_src</code> in each application / module.</p><p>By default this behavior is <strong>on</strong>. To turn it off you can set <code>MOOSE_UNITY=false</code> in your environment. Further, an application can disable it permanently by putting <code>MOOSE_UNITY := false</code> at the top of their Makefile.</p><p>In addition you can also keep from unity building individual directories within your project. By default <code>src</code> and <code>src/base</code> are not unity built because they generally contain a mix of objects that don't benefit from being built simultaneously. To add to that list, set the <code>app_non_unity_dirs</code> variable in your <code>Makefile</code> before the <code>include</code> of <code>app.mk</code> like so:</p><pre><code class="language-text">
app_non_unity_dirs = %/src/contrib/third_party_code %/src/contrib/other_non_unity_dir

include            $(FRAMEWORK_DIR)/app.mk
</code></pre><p>Make sure to prepend your directories with a <code>%</code> sign.</p></section><section data-section-text="Revision   Generation" data-section-level="3" id="8ca44423-fde2-4b21-9332-f0461bfd1ae1"><h3>Revision Generation</h3><p>The build process can generate C++ header files containing repository versioning information for use within your application. These header files are generated by default but can be disabled by setting a Make variable in your application's Makefile:</p><pre><code class="language-text">
# must be set before the app.mk file is included
GEN_REVISION := no
include      $(FRAMEWORK_DIR)/app.mk
</code></pre><p>The Revision file contains both a version string (git hash) and a revision string containing more detailed information or tagged information. Note that the name of your app will appear instead of "MOOSE" for your individual application: <code></code>` /* THIS FILE IS AUTOGENERATED - DO NOT EDIT */</p><p>#ifndef MOOSE_REVISION_H #define MOOSE_REVISION_H</p><p>#define MOOSE_REVISION "git commit f4abb66afa on 2018-03-07" #define MOOSE_VERSION "f4abb66afa"</p><p>#endif // MOOSE_REVISION_H <code></code>` </p></section></section></section></div><div class="col hide-on-med-and-down l2"><div class="toc-wrapper pin-top"><ul class="section table-of-contents"><li><a data-delay="1000" data-position="left" href="#71009780-10cc-4571-9ec8-8114a4385fab" class="tooltipped" data-tooltip="Overview">Overview</a></li><li><a data-delay="1000" data-position="left" href="#9d0760d1-9787-4c4a-96d0-e5158b1f87a6" class="tooltipped" data-tooltip="Controlling   The   Process :   Environment   Variables">Controlling   The   Process :   Environment   Variables</a></li><li><a data-delay="1000" data-position="left" href="#559bd896-85f2-43ee-8f77-4ce6a10e31c9" class="tooltipped" data-tooltip="Build   Methods   ( Creating   " debug "   Builds )">Build   Methods   ( Creating   " debug "   Builds )</a></li><li><a data-delay="1000" data-position="left" href="#68eb7733-ee52-450f-b3a5-8550c43102ac" class="tooltipped" data-tooltip="Build   System   Optimization">Build   System   Optimization</a></li></ul></div></div></div></div></main></div></body></html>